<!DOCTYPE html>
<html>
<head>
  {{ template "favicon.html" .}}
  
  <!-- Standard Meta -->
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <!-- Site Properties -->
  <title>{{ .title }}</title>
  
  <link rel="stylesheet" href="/css/semantic.min.css"/>
  <script src="/js/jquery.min.js"></script>
  <script src="/js/semantic.min.js"></script> 
  <link rel="stylesheet" href="/css/common.css"/>
  <link rel="stylesheet" href="/css/common_sub.css"/>
  <script src="/js/common.js"></script> 
  <link rel="stylesheet" href="css/spinner/spinners/3-wave.css"/>

  <script>
    var unverifiedImageEntries = [];
    var currentIdx = 0;
    var currentEntry = null;

    function getNextEntry() {
      $('#loadingIndicator').show();
      $('#controls').hide();
      $('#image').hide();
      $('#image').attr('src', '');
      $('#labels').text('');

      if(currentIdx >= unverifiedImageEntries.length) {
        $('#warningMessageBoxContent').text("No more images to unlock");
        $('#warningMessageBox').show(200).delay(1500).hide(200);
        $('#loadingIndicator').hide();
      }

      currentEntry = unverifiedImageEntries[currentIdx];
      var imageUrl = '{{ .apiBaseUrl }}/v1/unverified-donation/' + currentEntry["uuid"] + '?token=' + getCookie("imagemonkey");

      var img = new Image();
      img.onload = function() {
         $('#image').attr("src", this.src);
         $('#labels').text(currentEntry["label"]);
         $('#controls').show();
         $('#image').show();
         $('#loadingIndicator').hide();
      }
      img.src = imageUrl;

      currentIdx += 1;
    }

    function unlockImage(imageId, unlock) {
      $('#loadingIndicator').show();
      $('#controls').hide();
      $('#labels').text('');


      var url = '';
      if(unlock)
        url = '{{ .apiBaseUrl }}/v1/unverified/donation/' + imageId + '/good';
      else
        url = '{{ .apiBaseUrl }}/v1/unverified/donation/' + imageId + '/bad';

      var headers = {};
      headers['X-Client-Id'] = {{ .clientId }};
      headers['X-Client-Secret'] = {{ .clientSecret }};

      $.ajax({
        url: url,
        headers: headers,
        type: 'POST',
        dataType: 'json',
        beforeSend: function(xhr) {
          xhr.setRequestHeader("Authorization", "Bearer " + getCookie("imagemonkey"))
        },
        error: function(jqXHR, textStatus, errorThrown) {
          $('#warningMessageBoxContent').text("Couldn't unlock image");
          $('#warningMessageBox').show(200).delay(1500).hide(200);
          $('#loadingIndicator').hide();
        },
        success: function(data) {
          getNextEntry();
        }
      });
    }




    function getAllUnverifiedImageEntries() {
      $('#loadingIndicator').show();
      var url = '{{ .apiBaseUrl }}/v1/internal/unverified-donations';

      var headers = {};
      headers['X-Client-Id'] = {{ .clientId }};
      headers['X-Client-Secret'] = {{ .clientSecret }};

      $.ajax({
        url: url,
        headers: headers,
        type: 'GET',
        dataType: 'json',
        beforeSend: function(xhr) {
          xhr.setRequestHeader("Authorization", "Bearer " + getCookie("imagemonkey"))
        },
        error: function(jqXHR, textStatus, errorThrown) {
          $('#warningMessageBoxContent').text("Couldn't unlock image");
          $('#warningMessageBox').show(200).delay(1500).hide(200);
          $('#loadingIndicator').hide();
        },
        success: function(data) {
          $('#loadingIndicator').hide();
          unverifiedImageEntries = data;
          if(unverifiedImageEntries)
            getNextEntry();
        }
      });
    }

    $(document).ready(function() {
      getAllUnverifiedImageEntries();

      $('#noButton').click( function(e) {
        //just skip entry
        getNextEntry();
      });

      $('#yesButton').click( function(e) {
        unlockImage(currentEntry["uuid"], true);
      });

    });
  </script>
</head>
<body>

  {{ template "menu.html" .}}

  <!-- Page Contents -->
  <div class="pusher">
    <div class="ui inverted vertical masthead center aligned segment">
     {{ template "pointing_menu.html" .}}
     <div class="ui text container">
      <h2 class="ui inverted header">
        Unlock Image
      </h2>
    </div>
  </div>
  <div class="ui stackable center aligned grid vertical stripe">
    <div class="sixteen wide center aligned column">
      <img class="ui big centered image" id="image"/>

      <div class="ui center aligned basic segment" id="controls" style="display: none;">
        <h1 class="ui header" id="labels"></h1>
        <button class="negative ui button center aligned" id="noButton">NO</button>
        <button class="positive ui button center aligned" id="yesButton">YES</button>
      </div>

      <div class="row" id="loadingIndicator" style="display: none;">
        <div class="sk-wave overlay">
          <div class="sk-rect sk-rect1"></div>
          <div class="sk-rect sk-rect2"></div>
          <div class="sk-rect sk-rect3"></div>
          <div class="sk-rect sk-rect4"></div>
          <div class="sk-rect sk-rect5"></div>
        </div>
      </div>

      <div hidden class="ui warning message" hidden id="warningMessageBox">
        <i class="close icon"></i>
        <div class="header" id="warningMessageBoxContent">
        </div>
      </div>

    </div>
  </div>
</div>

{{ template "footer.html" .}}

</body>

</html>