<!DOCTYPE html>
<html>
<head>
  <!-- Standard Meta -->
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <!-- Site Properties -->
  <title>{{ .title }}</title>
  
  <link rel="stylesheet" href="css/semantic.min.css"/>
  <script src="js/jquery.min.js"></script>
  <script src="js/semantic.min.js"></script> 
  <script src="js/semantic.min.js"></script> 
  <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">

  <link rel="stylesheet" href="css/common.css"/>
  <link rel="stylesheet" href="css/common_sub.css"/>
  <script src="js/ace/ace.js"></script> 
  <script src="js/ace/ext-language_tools.js"></script>
  <script src="js/d3.v4.min.js"></script>
  <script src="http://d3js.org/d3-selection-multi.v1.js"></script>

  <style>

	/*.links line {
	  	stroke: #999;
	  	stroke-opacity: 0.6;
	}*/

	.nodes circle {
	  	stroke: #fff;
	  	stroke-width: 1.5px;
	}

	.tooltip {
	  	position:absolute;
	  	text-align: center;
	  	width: 450px;
	  	height:auto;
	  	background-color: #ffffff;
	  	color: #787777;
	  	padding: 6px 12px;
	  	z-index:3;

	  	//box shadow (generated with: https://www.cssmatic.com/box-shadow)
	  	-webkit-box-shadow: 7px 7px 35px -20px rgba(0,0,0,1);
	  	-moz-box-shadow: 7px 7px 35px -20px rgba(0,0,0,1);
	  	box-shadow: 7px 7px 35px -20px rgba(0,0,0,1);
	}

	.tooltip span {
	    display: block;
	    text-align: center;
	    width: 450px;
	    height: auto;
	    margin: 5px auto;
  	}

	#tooltipDescription {
    	display:block;
    	width: 400px;
    	word-wrap:break-word;
  	}

	#thumbnail {
	    width: 450px;
	    height: auto;
	    margin: 0 auto;
	    color: #787777;
	    text-align: center;
  	}

  	.link { stroke: #999; stroke-opacity: .6; stroke-width: 5px; }

  	/*#editorContainer {
	    width: 100%;
	    height: 100%;
	}

	#editor {
	    width: 80%;
	    //width: 100%;
	    //height: 100%;
	    margin: auto;
	}*/


  </style>

  <script type="text/javascript">
  	var link, simulation, svg, node, radius, color, tooltip, zoom, main, link, edgepaths, edgelabels;
  	var editor;

	$(document).ready(function(){
		{{ if eq .editorMode true }}
		initializeEditor();
		{{ end }}

		initializeGraph();

		$('#refreshLabelGraphButton').click(function(e) {
        	evaluateGraph();
      	});

      	$('#zoomInButton').click(function(e) {
        	zoomMe(1.2); // increase on 0.2 each time
      	});

      	$('#zoomOutButton').click(function(e) {
        	zoomMe(1/1.2); // decrease on 0.2 each time
      	});
	});

	function initializeEditor() {
		ace.config.set('themePath', 'js/ace/themes/');
		ace.config.set('modePath', 'js/ace/');

		$("#editorContainer").css("height", "500px");
		$("#editorContainer").css("width", "500px");
		editor = window.ace.edit("editor");
		editor.resize();

		editor.setValue(`digraph G { 
    { rootnode [label="root" size=250 fontsize=25 color=red] } 
    { r1 [label="r1" color=green] } 
    { r2 [label="r2" color=green] } 
    { r3 [label="r3" color=green] } 
    { r4 [label="r4"] } 
    { r5 [label="r5"] }
    { r6 [label="r6" color=blue] }
    { r7 [label="r7" color=blue] }
    
    rootnode -> r1
    rootnode -> r2
    rootnode -> r3
    rootnode -> r4
    rootnode -> r5
    
    r5 -> r6
    r6 -> r7 [label="link" len=150 fontsize=20]
    
}`);

		editor.setOptions({
		   enableBasicAutocompletion: true, // the editor completes the statement when you hit Ctrl + Space
		   enableLiveAutocompletion: true, // the editor completes the statement while you are typing
		   showPrintMargin: false, // hides the vertical limiting strip
		   maxLines: 30,
		   minLines: 30,
		   fontSize: "100%" // ensures that the editor fits in the environment

		});

		// defines the style of the editor
		editor.setTheme("ace/theme/tomorrow_night_eighties");

		// hides line numbers (widens the area occupied by error and warning messages)
		editor.renderer.setOption("showLineNumbers", true); 

		// ensures proper autocomplete, validation and highlighting of dot code
		editor.getSession().setMode("ace/mode/dot");
	}

	function buildQuery(identifier) {
		var url = '{{ .apiBaseUrl }}/v1/label/graph/' + {{ .defaultLabelGraphName }} + '/query-builder';
		$.ajax({
	      url: url,
	      dataType: 'json',
	      data: {identifier: encodeURIComponent(identifier)},
	      success: function(data){
	      	window.location.href = encodeURI('/explore/?query=' + data.query); //redirect to explore page
	      }
	    });
	}

	function showWikipediaPagePreview(name, xPos, yPos) {
		var url = 'https://en.wikipedia.org/api/rest_v1/page/summary/' + name;
		$.ajax({
	      url: url,
	      dataType: 'json',
	      success: function(data){
	      	showTooltip(name, data, xPos, yPos);
	      }
	    });
	}

	function evaluateGraph() {
		var url = '{{ .apiBaseUrl }}/v1/label/graph-editor/evaluate';
	    $.ajax({
	      url: url,
	      data: JSON.stringify({data: btoa(editor.getValue())}),
	      type: 'POST',
	      success: function(data){
	      	populateGraph(data);
	      }, 
	      error: function(jqXHR,error, errorThrown) {
	      	$('#labelGraphEditorWarningMsgText').text("Can't parse file - please check for syntax errors!");
          	$('#labelGraphEditorWarningMsg').show(200).delay(1500).hide(200);
	      }
	    });
	}


	function initializeGraph() {
		{{ if eq .editorMode false }}
		var url = '{{ .apiBaseUrl }}/v1/label/graph/' + {{ .defaultLabelGraphName }};
		$.ajax({
	      url: url,
	      dataType: 'json',
	      success: function(data){
	      	populateGraph(data);
	      }
	    });
	    {{ else }}
	    	evaluateGraph();
	    {{ end }}
	}

	function populateGraph(graph) {
		d3.select("#labelGraph").html(null); //clear all

		var maxWidth = document.getElementById("labelGraphContainer").clientWidth - 50;
		var maxHeight = 1500;
		$("#labelGraph").attr("width", maxWidth);
		$("#labelGraph").attr("height", maxHeight);

		svg = d3.select("#labelGraph"),
	    	width = +svg.attr("width"),
	    	height = +svg.attr("height")

	    main = svg.append("g");


	    zoom = d3.zoom()
            .scaleExtent([1, 10])
            .on("zoom", zoomed);

		color = d3.scaleOrdinal(d3.schemeCategory20);
	  
		radius = d3.scaleSqrt()
	    	.range([0, 6]);

		simulation = d3.forceSimulation(graph.links)
		.force("link", d3.forceLink()
			.id(function(d) { return d.id; }))
		.force("charge", d3.forceManyBody()
			.strength(function(d) { return -600;}))
		.force("center", d3.forceCenter(width / 2, height / 2))
		.force("link", d3.forceLink()
			.distance(function(d) { return d.distance; }).strength(1));
		//.force("link", d3.forceLink().id(function(d) { return d.id; }).distance(function(d) { return d.size; }).strength(1));
		//.force("linkForce", function(d) { return 100; });

		svg.append('defs').append('marker')
        .attrs({'id':'arrowhead',
            'viewBox':'-0 -5 10 10',
            'refX':13,
            'refY':0,
            'orient':'auto',
            'markerWidth':20,
            'markerHeight':20,
            'xoverflow':'visible'})
        .append('svg:path')
        .attr('d', 'M 0,-5 L 10 ,0 L 0,5')
        .attr('fill', '#999')
        .style('stroke','none');


		link = main.selectAll(".link")
            .data(((graph.links === null) ? [] : graph.links))
            .enter()
            .append("line")
            .attr("class", "link")
            //.attr('marker-end','url(#arrowhead)')

        link.append("title")
            .text(function (d) {return d.type;});

        edgepaths = main.selectAll(".edgepath")
            .data(((graph.links === null) ? [] : graph.links))
            .enter()
            .append('path')
            .attrs({
                'class': 'edgepath',
                'fill-opacity': 0,
                'stroke-opacity': 0,
                'id': function (d, i) {return 'edgepath' + i}
            })
            .style("pointer-events", "none");

        edgelabels = main.selectAll(".edgelabel")
            .data(((graph.links === null) ? [] : graph.links))
            .enter()
            .append('text')
            .style("pointer-events", "none")
            .attrs({
                'class': 'edgelabel',
                'id': function (d, i) {return 'edgelabel' + i},
                'font-size': function (d) {return d.fontsize; },
                'fill': '#aaa'
            });

        edgelabels.append('textPath')
            .attr('xlink:href', function (d, i) {return '#edgepath' + i})
            .style("text-anchor", "middle")
            .style("pointer-events", "none")
            .attr("startOffset", "50%")
            .text(function (d) {return d.label});


	  	node = main.append("g")
	      .attr("class", "nodes")
	    .selectAll("g")
	    .data(graph.nodes)
	    .enter().append("g")
	  		.style('transform-origin', '50% 50%')
	   	.call(d3.drag()
	          .on("start", dragstarted)
	          .on("drag", dragged)
	          .on("end", dragended));
	  
	  	node.append('circle')
	      .attr("r", function(d) { return radius(d.size / 2); })
	      .attr("fill", function(d) { 
	      					if(d.color === "") //in case no color is provided, default to grey
	      						return d3.color("grey");
	      					return d3.color(d.color); 
	      				})
	      .attr("label-identifier", function(d) { return d.identifier; })
	      .attr("label-uuid", function(d) { return d.uuid; })
	      .on("click", onNodeClicked)
	      .on("mouseenter", function(d) {
	      		if(d.onhover !== "") { //in case the node contains a 'onhover' property
	      			showWikipediaPagePreview(d.name, d3.event.pageX, d3.event.pageY);
	            }
            })

            .on("mouseout", function(d) {
            	hideTooltip();
	        });

	    
	  
	  	node.append("text")
	  	  .text(function(d) { return d.name; })
	      .attr("dy", ".35em")
	      .attr("text-anchor", "middle")
	      .style("font-size", function(d) { return d.fontsize.toString() + "px"; })
	      .attr("pointer-events", "none"); //ignore pointer events for text

	  	simulation
	      .nodes(graph.nodes)
	      .on("tick", ticked);


	  	simulation.force("link")
	      .links(((graph.links === null) ? [] : graph.links));

	    tooltip = d3.select("body")
                  .append("div")
                        .attr("class", "tooltip")
                        .style("opacity", 0)
                        .style("position","fixed")
                        .style("display", "block")
                        .style("top", 100)
                        .style("left", 100)
                        .style("pointer-events","none");

    	svg.call(zoom).append("g");
	    
	}

	function hideTooltip() {
	    d3.selectAll(".crosshair")
	        .style("display", "none");

	    tooltip.transition()
	        .duration(100)       
	        .style("display", "none");
	}

	function showTooltip(nodeName, data, xPos, yPos) {
        d3.selectAll(".crosshair")
        .style("display", "block");

        tooltip
        .style("top", (yPos + 2) + "px")
        .style("left", (xPos - 28) + "px")
        .style("opacity", 0.9)
        .style("display", "block")
        .html(
        	"<div id='thumbnail'><span>" + nodeName + "</span><img src='" + data["thumbnail"]["source"] + "' /><span id='tooltipDescription'>" + data["extract_html"] + "</span></div>")
        .style("left", (xPos - 113) + "px")   
        .style("top", (yPos - 190) + "px");
	}


	function ticked() {
		link
            .attr("x1", function (d) {return d.source.x;})
            .attr("y1", function (d) {return d.source.y;})
            .attr("x2", function (d) {return d.target.x;})
            .attr("y2", function (d) {return d.target.y;});

        node
            .attr("transform", function (d) {return "translate(" + d.x + ", " + d.y + ")";});

        edgepaths.attr('d', function (d) {
            return 'M ' + d.source.x + ' ' + d.source.y + ' L ' + d.target.x + ' ' + d.target.y;
        });

        edgelabels.attr('transform', function (d) {
            if (d.target.x < d.source.x) {
                var bbox = this.getBBox();

                rx = bbox.x + bbox.width / 2;
                ry = bbox.y + bbox.height / 2;
                return 'rotate(180 ' + rx + ' ' + ry + ')';
            }
            else {
                return 'rotate(0)';
            }
        });

        //push link label a bit away from link to avoid overlapping
        edgelabels.attr('dy', '-3');
	}

	function onNodeClicked(d, i) {
		d3.select(this).transition()
	      .style("fill", "black")
	      .attr("r", 64)
	    .transition()
	      .attr("r", 32)
	      .style("fill", color(i));

	    buildQuery(d3.select(this).attr("label-identifier"));
	}

	function dragstarted(d) {
	  if (!d3.event.active) simulation.alphaTarget(0.3).restart();
	  d.fx = d.x;
	  d.fy = d.y;
	}

	function dragged(d) {
	  d.fx = d3.event.x;
	  d.fy = d3.event.y;
	}

	function dragended(d) {
	  if (!d3.event.active) simulation.alphaTarget(0);
	  d.fx = null;
	  d.fy = null;
	}

	function zoomed() {
		main.attr("transform", d3.event.transform);
    }
    function zoomMe(zoomLevel) {
  		svg.transition()
	      .delay(100)
	      .duration(700)
	      .call(zoom.scaleBy, zoomLevel);
	}

   </script>
</head>
<body>
	{{ template "menu.html" .}}

	<!-- Page Contents -->
	<div class="pusher">
		<div class="ui inverted vertical masthead center aligned segment">
			{{ template "pointing_menu.html" .}}
			<div class="ui text container">
				<h2 class="ui inverted header">{{ .title }}</h2>
			</div>
		</div>

		{{ if eq .editorMode false }}
		<div class="ui stackable grid vertical stripe mobile reversed" style="margin-top:-9em;">
		{{ else }}
		<div class="ui stackable grid vertical stripe mobile reversed">
		{{ end }}
			
			{{ if eq .editorMode true }}
			<div class="row">
				<div class="two wide column"></div>
				<div class="twelve wide column" id="editor"></div>
				<div class="two wide column"></div>
			</div>
			<div class="row">
				<div class="two wide column"></div>
				<div class="twelve wide center aligned column">
					<div hidden class="ui warning message" id="labelGraphEditorWarningMsg">
			            <i class="close icon"></i>
			            <div class="header" id="labelGraphEditorWarningMsgText">
			            </div>
		          	</div>
		        </div>
		        <div class="two wide column"></div>
		    </div>

			<div class="row">
				<div class="sixteen wide center aligned column">
					<button class="ui blue button" id="refreshLabelGraphButton">
					  <i class="icon refresh"></i>
					  Update
					</button>
				</div>
			</div>
			{{ end }}

			<div class="row" style="margin-top:1em; margin-right:1em;">
				<div class="sixteen wide right aligned column">
					<button class="ui button" button id="zoomInButton"><i class="search plus icon"></i> Zoom In</button>
  					<button class="ui button" id="zoomOutButton"><i class="search minus icon"></i> Zoom Out</button>
				</div>
				<div class="sixteen wide center aligned column" id="labelGraphContainer">
					<svg id="labelGraph"></svg>
				</div>
			</div>
		</div>
	</div>
</body>
</html>
