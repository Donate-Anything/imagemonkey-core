<!DOCTYPE html>
<html>
<head>
  {{ template "favicon.html" .}}
  
  <!-- Standard Meta -->
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <!-- Site Properties -->
  <title>{{ .title }}</title>
  
  <link rel="stylesheet" href="/css/semantic.min.css"/>
  <script src="/js/jquery.min.js"></script>
  <script src="/js/semantic.min.js"></script> 
  <link rel="stylesheet" href="/css/common.css"/>
  <link rel="stylesheet" href="/css/common_sub.css"/>
  <script src="/js/common.js"></script> 
  <link rel="stylesheet" href="css/spinner/spinners/3-wave.css"/>
  <script src="js/tablesort/tablesort.js"></script>

  <script>
    function addTrendingLabel(elem) {
      var url = '{{ .apiBaseUrl }}/v1/trendinglabels/' + $(elem).attr("data-label") + "/accept";
      $.ajax({
        url: url,
		type: 'POST',
        dataType: 'json',
        beforeSend: function(xhr) {
          xhr.setRequestHeader("Authorization", "Bearer " + getCookie("imagemonkey"))
        },
        success: function(data) { 
          
        }
      });	
	}
	function getTrendingLabels() {
      $("#loadingIndicator").show();
      var url = '{{ .apiBaseUrl }}/v1/trendinglabels';
      $.ajax({
        url: url,
        dataType: 'json',
        beforeSend: function(xhr) {
          xhr.setRequestHeader("Authorization", "Bearer " + getCookie("imagemonkey"))
        },
        error: function(jqXHR, textStatus, errorThrown) {
          $("#loadingIndicator").hide();
          $('#warningMessageBoxContent').text("Couldn't get trending labels - please try again later");
          $('#warningMessageBox').show(200).delay(1500).hide(200);
        },
        success: function(data) {
          $("#loadingIndicator").hide();
          populateLabelRepositoryTable(data);
        }
      });
    }

    function populateLabelRepositoryTable(data) {
      $("#loadingIndicator").show();

	  {{ if eq .sessionInformation.Username "" }}
	  $("#authenticationNeededInfoMessage").show(); 
	  {{ end }}

      for(var i = 0; i < data.length; i++) {
		var githubIssueUrl = ('<a href="' + {{ .trendingLabelsRepositoryUrl }} + 
								'/issues/' + data[i].github_issue.id + '">' +
								'#' +  data[i].github_issue.id + '</a>');
		var cellColor = data[i].github_issue.closed ? "#76ff03" : "#ffffff";
		var status = data[i].status;
		var button = '';

		var disabledStr = '';
		{{ if eq .sessionInformation.Username "" }}
		disabledStr = 'disabled ';
		{{ end }}

		var ciJobUrl = data[i].ci.job_url;

		var escapedTrendingLabel = escapeHtml(data[i].name);
		if(status === '') {
			status = 'open';	
			button = ('<div class="ui fluid ' + disabledStr + 'button" data-label="' + 
						 escapedTrendingLabel+ '" onclick="addTrendingLabel(this);">Add</div>');
		} else if(status === 'waiting for moderator approval') {
			{{ if .sessionInformation.UserPermissions }}
			{{ if eq .sessionInformation.UserPermissions.CanAcceptTrendingLabel true }}
			button = '<div class="ui fluid button" data-label="' + escapedTrendingLabel + '" onclick="addTrendingLabel(this);">Accept</div>';
			{{ end }}
			{{ end }}
		} else if(status === 'building') {
			status = '<a href="' + ciJobUrl + '">building</a>';	
		} else if(status === 'build-passed') {
			status = '<a href="' + ciJobUrl +'"><img src="https://img.shields.io/travis/73VW/TechnicalReport.svg"></img></a>';
		} else if((status === 'build-failed') || (status === 'build-canceled')) {
			status = '<a href="' + ciJobUrl +'"><img src="https://img.shields.io/travis/73VW/TechnicalReport/build.svg"></img></a>';
			button = '<div class="ui fluid ' + disabledStr + ' button" data-label="' + escapedTrendingLabel + '" onclick="addTrendingLabel(this);">Try again</div>';
		}

        elem = $(('<tr>' +
                    '<td>' + escapedTrendingLabel  + '</td>' +	
                    '<td class="center aligned">' + githubIssueUrl + '</td>' +
					'<td class="center aligned" bgcolor="' + cellColor + '">' + status + '</td>' +
					'<td class="">' + button + '</td>' +
                  '</tr>'));
        $("#labelRepositoryTableContent").append(elem);
      }
      $("#labelRepositoryTable").tablesort();
      $("#loadingIndicator").hide();
    }
    $(document).ready(function() {
      getTrendingLabels();
    });
  
  </script>
</head>
<body>

  {{ template "menu.html" .}}

  <!-- Page Contents -->
  <div class="pusher">
    <div class="ui inverted vertical masthead center aligned segment">
     {{ template "pointing_menu.html" .}}
     <div class="ui text container">
      <h2 class="ui inverted header">
        Label Repository
      </h2>
    </div>
  </div>
  <div class="ui stackable center aligned grid vertical stripe">
    <div class="row" id="loadingIndicator" style="display: none;">
      <div class="sk-wave overlay">
        <div class="sk-rect sk-rect1"></div>
        <div class="sk-rect sk-rect2"></div>
        <div class="sk-rect sk-rect3"></div>
        <div class="sk-rect sk-rect4"></div>
        <div class="sk-rect sk-rect5"></div>
      </div>
    </div>

	<div class="row">
	  <div class="four wide center aligned column"></div>
	  <div class="eight wide center aligned column">
	  	<div hidden class="ui info message" id="authenticationNeededInfoMessage">
  		  <i class="close icon"></i>
  		  <div class="header">
    	   Authenticate if you want to trigger builds
  		  </div>
		</div>
	  </div>
	  <div class="four wide center aligned column"></div>
	</div>

    <div class="row">
      <div class="four wide center aligned column"></div>
      <div class="eight wide center aligned column">
        <div class="ui segment">
          <table class="ui striped sortable table" id="labelRepositoryTable">
            <thead>
              <tr>
                <th>Name</th>
                <th class="center aligned"><i class="github icon"></i>Github</th>
				<th class="center aligned"><i class="question circle icon"></i>Status</th>
				<th class=""></th>
              </tr>
            </thead>
            <tbody id="labelRepositoryTableContent">

            </tbody>
          </table>
        </div>
      </div>
      <div class="four wide center aligned column"></div>
    </div>


  </div>
</div>

{{ template "footer.html" .}}

</body>

</html>
