<!DOCTYPE html>
<html>
<head>
  <!-- Standard Meta -->
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <!-- Site Properties -->
  <title>{{ .title }}</title>
  
  <link rel="stylesheet" href="css/semantic.min.css"/>
  <script src="js/jquery.min.js"></script>
  <script src="js/semantic.min.js"></script> 
  <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">

  <link rel="stylesheet" href="css/common.css"/>
  <link rel="stylesheet" href="css/common_sub.css"/>
  <script src="js/common.js"></script> 

  <script src="js/fingerprint2.min.js"></script>

  <script type="text/javascript">
  var oldLabels = {}
  var newlyAddedLabels = {}

  function labelExists(label){
    if(label in oldLabels)
      return true;
    if(label in newlyAddedLabels)
      return true;
    return false;
  }

  function getNextImage(){
    $('#newLabel').val(''); //clear current label
    removeAllLabels();
    $('#suggestedLabelsContainer').hide();
    removeAllSuggestedLabels();
    oldLabels = {}
    newlyAddedLabels = {}


    var url = '{{ .apiBaseUrl }}/v1/labelme';
    $.ajax({
      url: url,
      dataType: 'json',
      complete: function(data){
      },
      success: function(data){
        $("#image").attr("imageId", data.uuid);
        $("#image").attr("src", ("donations/"+data.uuid));
        oldLabels = {};
        var labelStr = "";
        for(var i = 0; i < data["all_labels"].length; i++){
          oldLabels[data["all_labels"][i]] = true;

          labelStr += data["all_labels"][i];

          $('#labels').prepend($(('<div class="ui big label">' + data["all_labels"][i] + '</div>')));
        }

        //get suggested labels
        getSuggestedLabels(labelStr);
      }
    });
  }

  function getSuggestedLabels(labels){
    var url = '{{ .apiBaseUrl }}/v1/label/suggest?tags=' + labels;
    $.ajax({
      url: url,
      dataType: 'json',
      complete: function(data){
      },
      success: function(data){
        for(var i = 0; i < data.length; i++){
          addLabelSuggestion(data[i]);
        }

        if(data.length > 0 ) //only show if there is at least one suggestion
          $("#suggestedLabelsContainer").fadeIn("slow");
      }
    });
  }

  var removeLabel = function(e){
    delete newlyAddedLabels[$(e).parent().text()];
    $(e).parent().remove();
  };

  var createLabelFromLabelSuggestion = function(e){
    addLabel($(e).text());
  };

  var removeAllLabels = function(){
    $('#labels').children().each(function (){
      delete newlyAddedLabels[$(this).text()];
      $(this).remove();
    })
  }

  var removeAllSuggestedLabels = function(){
    $('#suggestedLabels').children().each(function (){
      $(this).remove();
    })
  }

  function addLabel(label){
    if(!labelExists(label)){
      newlyAddedLabels[label] = true;
      $('#labels').prepend($(('<div class="ui huge label">' + label + '<i class="delete icon" onclick="removeLabel(this)"></i></div>')));
    }
  }

  function addLabelSuggestion(label){
    $('#suggestedLabels').prepend($(('<div class="ui big label button" onclick="createLabelFromLabelSuggestion(this)">' + label + '</div>')));
  }

  $(document).ready(function(){
    $('#suggestedLabelsContainer').hide();
    var browserFingerprint = null;

    var labelStr = "";
    {{range .image.AllLabels}}
    oldLabels[{{.}}] = true;
    labelStr += ( {{.}} + "," );
    {{ end }}

    getSuggestedLabels(labelStr);

    $('#addLabelButton').click(function(e){
      if($('#newLabel').val() !== ""){
        addLabel($('#newLabel').val());
          $('#newLabel').val(''); //clear label after add
        }
      });


      //when enter gets pressed in input, add label
      $("#newLabel").on('keyup', function (e){
        if (e.keyCode == 13){
          if($('#newLabel').val() !== ""){
            addLabel($('#newLabel').val());
              $('#newLabel').val(''); //clear label after add
            }
          }
        });



      $('#doneButton').click(function(e) {
        var labelsLst = [];

        //dict to list
        for (var key in newlyAddedLabels){
          if (newlyAddedLabels.hasOwnProperty(key)){
            labelsLst.push(key);
          }
        }

        var url = '{{ .apiBaseUrl }}/v1/donation/' + $("#image").attr("imageId") + "/labelme";
        var headers = {}
        if(browserFingerprint !== null)
          headers['X-Browser-Fingerprint'] = browserFingerprint;

        if(newlyAddedLabels.length === 0){ //if no label was added, just load next image
          getNextImage();
        }
        else {
          e.preventDefault();
          $.ajax({
            url: url,
            dataType: 'json',
            type: 'POST',
            data: JSON.stringify({labels: labelsLst}),
            headers: headers,
            complete: function(data){
            },
            success: function(data){
              getNextImage();
            }
          });
        }
        
      });

      $('.ui.search')
      .search({
        debug: true,
        apiSettings: {
          url: '{{ .apiBaseUrl}}/v1/label/search?q={query}'
        },
        fields: {
          results : 'items',
          title   : 'label'
        },
        minCharacters : 2,
        searchOnFocus: false,
        showNoResults: false,
      });

      new Fingerprint2().get(function(result, components){
        browserFingerprint = result;
      });

    });
</script>
</head>
<body>

  {{ template "menu.html" .}}

  <!-- Page Contents -->
  <div class="pusher">
    <div class="ui inverted vertical masthead center aligned segment">
      {{ template "pointing_menu.html" .}}
      <div class="ui text container">
       <h2 class="ui inverted header">Label all objects</h2>
     </div>
   </div>

   <div class="ui stackable grid vertical stripe">
    <div class="one wide column">
    </div>
    <div class="three wide center aligned column">
      <p><h2>Labels:</h2></p>

      <div id="labels">
        {{range .image.AllLabels}}
        <div class="ui big label">{{.}}
        </div>
        {{ end }}
      </div>

      <h1></h1>
      <h1></h1>
      <div id="suggestedLabelsContainer">
        <h2 style="margin-bottom:0px;">Suggested Labels:</h2>
        <p style="font-size:12px; margin-bottom:20px;">Similar images have the following labels</p>
        <div id="suggestedLabels">
        </div>
      </div>

    </div>
    <div class="eight wide center aligned column">
      <img class="ui large image centered" src="donations/{{ .image.Id }}" imageId="{{ .image.Id }}" id="image">
      

      <h2></h2>
      <p>Do you see any objects without a label? Add them here</p>
      <div class="ui centered grid">
        <div class="row">
          <div class="ui search">
            <div class="ui center aligned action input">
              <input class="prompt" placeholder="Enter Label..." type="text" id="newLabel">
              <button class="ui button" id="addLabelButton">Add</button>
            </div>
          </div>
          <h1></h1>
        </div>
      </div>

      <div class="row">
        <div class="ui centered grid">
          <div class="four wide center aligned column">
            <button class="ui fluid positive button" id="doneButton">Done</button>
          </div>
        </div>
      </div>

      {{ template "label_help_dlg.html" .}}
      {{ template "report_dlg.html" .}}
    </div>


    <div class="four wide center aligned column">
      {{ template "img_info.html" .}}
    </div>
  </div>


</div>
{{ template "footer.html" .}}

</body>

</html>