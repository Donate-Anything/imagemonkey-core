<!DOCTYPE html>
<html>
<head>
  <!-- Standard Meta -->
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <!-- Site Properties -->
  <title>{{ .title }}</title>
  
  <link rel="stylesheet" href="css/semantic.min.css"/>
  <script src="js/jquery.min.js"></script>
  <script src="js/semantic.min.js"></script> 
  <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">

  <link rel="stylesheet" href="css/common.css"/>
  <link rel="stylesheet" href="css/common_sub.css"/>
  <script src="js/common.js"></script> 
  <script src="js/label.js"></script>

  <script src="js/fingerprint2.min.js"></script>

  <script type="text/javascript">
  var colorMap = {}
  var oldLabelMap = {}
  var newlyAddedLabels = {}
  var labelMap = {{ .labels }};

  buildColorMap();

  function labelExists(label){
    if(label in oldLabelMap)
      return true;
    if(label in newlyAddedLabels)
      return true;
    return false;
  }

  function buildColorMap(){
    for(var key in labelMap){
      if(labelMap.hasOwnProperty(key)){
        var color = StringToColor.next(key);
        colorMap[key] = color;
      }
    }
  }

  function sublabelExists(label, sublabel){
    var sublabels = [];
    if(label in oldLabelMap){
      var sublabels = oldLabelMap[label];
      if(sublabels !== null){
        for(var i = 0; i < sublabels.length; i++){
          if(sublabels[i] === sublabel)
            return true;
        }
      }
    }
    if(label in newlyAddedLabels){
      var sublabels = newlyAddedLabels[label];
      if(sublabels !== null){
        for(var i = 0; i < sublabels.length; i++){
          if(sublabels[i] === sublabel)
            return true;
        }
      }
    }
    return false;
  }

  function getNextImage(){
    clearSelectedLabel(); //clear current label
    removeAllLabels();
    $('#mostPopularLabelsContainer').hide();
    removeAllMostPopularLabels();
    oldLabelMap = {}
    newlyAddedLabels = {}


    var url = '{{ .apiBaseUrl }}/v1/labelme';
    $.ajax({
      url: url,
      dataType: 'json',
      complete: function(data){
      },
      success: function(data){
        $("#image").attr("imageId", data.uuid);
        $("#image").attr("src", ("donations/"+data.uuid));

        addOldLabels(data["all_labels"]);

        //get suggested labels
        getMostPopularLabels();
      }
    });
  }

  function showHideNoLabelsDefined(){
    if((Object.keys(oldLabelMap).length === 0) && (Object.keys(newlyAddedLabels).length === 0)){
      $("#noLabelsDefined").show();
    }
    else{
      $("#noLabelsDefined").hide();
    }
  }

  function addOldLabels(input) {
    oldLabelMap = {};
    if(input !== null){
      for(var i = 0; i < input.length; i++){
        oldLabelMap[input[i]["label"]] = input[i]["sublabels"];
        addOldLabel(input[i]["label"]);
      }
    }

    showHideNoLabelsDefined();
  }

  function getMostPopularLabels(){
    var url = '{{ .apiBaseUrl }}/v1/label/popular';
    $.ajax({
      url: url,
      dataType: 'json',
      complete: function(data){
      },
      success: function(data){
        if(data !== null){
          for(var i = 0; i < data.length; i++){
            addPopularLabel(data[i]);
          }

          if(data.length > 0 ) //only show if there is at least one suggestion
            $("#mostPopularLabelsContainer").fadeIn("slow");
        }
      }
    });
  }

  var removeLabel = function(e){
    var sublabel = $(e).parent().attr('sublabel');
    var label = $(e).parent().attr('label');
    if(sublabel === undefined){ //remove base label + all it's sublabels
      //remove actual label...
      $(e).parent().remove();

      //..and all it's sublabels
      $('#labels').children().each(function (){
        if($(this).attr("label") === label){
          $(this).remove();
        }
      })

      delete newlyAddedLabels[label];
    }
    else{ //remove a specific sublabel
      sublabels = newlyAddedLabels[label];
      var index = sublabels.indexOf(sublabel);
      if(index > -1){
        sublabels.splice(index, 1);
      }
      newlyAddedLabels[label] = sublabels;
      $(e).parent().remove();
    }

    showHideNoLabelsDefined();
  };

  var createLabelFromMostPopularLabel = function(e){
    addLabel($(e).text());
  };

  var removeAllLabels = function(){
    $('#labels').children().each(function (){
      delete newlyAddedLabels[$(this).text()];
      $(this).remove();
    })
  }

  var removeAllMostPopularLabels = function(){
    $('#mostPopularLabels').children().each(function (){
      $(this).remove();
    })
  }


  function addOldLabel(label){
    var color = colorMap[label];
    var subLabels = oldLabelMap[label];
    if((subLabels !== null) && (subLabels.length > 0)){
      for(var i = 0; i < subLabels.length; i++){
        $('#labels').prepend($(('<div class="ui huge ' + color + ' label" sublabel="' + subLabels[i] +'" label="' + label + '"' + '>' + subLabels[i] + '/' + label + '</div>')));
      }

    }
    $('#labels').prepend($(('<div class="ui huge ' + color + ' label" label="' + label +  '" >' + label + '</div>')));
  }

  function addLabel(label){
    var added = false;
    var baseLabelExists = labelExists(label); 
    var subLabels = labelMap[label]["labels"];
    var color = colorMap[label];

    if((subLabels !== null) && (subLabels.length > 0)){
      for(var j = 0; j < subLabels.length; j++){
        if(!sublabelExists(label, subLabels[j].name)){
          $('#labels').prepend($(('<div class="ui huge ' + color + ' label" sublabel="' + subLabels[j]["name"] +'" label="' + label + '"' + '>' + subLabels[j]["name"] + '/' + label + '<i class="delete icon" onclick="removeLabel(this)"></i></div>')));
          added = true;

          if(label in newlyAddedLabels){
            var alreadyAvailableSubLabels = newlyAddedLabels[label];
            alreadyAvailableSubLabels.push(subLabels[j].name)
            newlyAddedLabels[label] = alreadyAvailableSubLabels;
          }
          else{
            newlyAddedLabels[label] = [subLabels[j].name];
          }
        }
      }    
    }
    else{ 
      if(!baseLabelExists)
        newlyAddedLabels[label] = [];
    }

    if(!baseLabelExists){
      added = true;
      $('#labels').prepend($(('<div class="ui huge ' + color + ' label" label="' + label +  '" >' + label + '<i class="delete icon" onclick="removeLabel(this)"></i></div>')));
    }

    if(!added)
      $('#labelAlreadyExistsMessage').show(200).delay(1500).hide(200);

    showHideNoLabelsDefined();
  }

  function addPopularLabel(label){
    $('#mostPopularLabels').prepend($(('<div class="ui big label button" onclick="createLabelFromMostPopularLabel(this)">' + label + '</div>')));
  }

  function getSelectedLabel(){
    return $('#labelDropdown').dropdown('get text');
  }

  function clearSelectedLabel(){
    $('#labelDropdown').dropdown('restore placeholder text');
  }

  $(document).ready(function(){
    $('#labelAlreadyExistsMessage').hide();
    $('#mostPopularLabelsContainer').hide();
    var browserFingerprint = null;
    var oldLabels = {{ .image.AllLabels }};
    addOldLabels(oldLabels);

    getMostPopularLabels();

    $('#addLabelButton').click(function(e){
      var selectedLabel = getSelectedLabel();
      if(selectedLabel !== ""){
        addLabel(selectedLabel);
        clearSelectedLabel(); //clear label after add
      }
    });

  $('#doneButton').click(function(e) {
    var labelsLst = [];

        //dict to list
        for (var key in newlyAddedLabels){
          if (newlyAddedLabels.hasOwnProperty(key)){
            labelsLst.push({label: key, sublabels: newlyAddedLabels[key]});
          }
        }

        var url = '{{ .apiBaseUrl }}/v1/donation/' + $("#image").attr("imageId") + "/labelme";
        var headers = {}
        if(browserFingerprint !== null)
          headers['X-Browser-Fingerprint'] = browserFingerprint;

        if(newlyAddedLabels.length === 0){ //if no label was added, just load next image
          getNextImage();
        }
        else {
          e.preventDefault();
          $.ajax({
            url: url,
            dataType: 'json',
            type: 'POST',
            data: JSON.stringify(labelsLst),
            headers: headers,
            complete: function(data){
            },
            success: function(data){
              getNextImage();
            }
          });
        }
        
      });

      /*$('.ui.search')
      .search({
        type: 'category',
        debug: true,
        apiSettings: {
          onResponse: function(imageMonkeyResponse) {
            var
              response = {
                results : {}
              }
            ;
            // translate GitHub API response to work with search
            $.each(imageMonkeyResponse.items, function(index, item) {
              var
                parent_label   = item.parent_label,
                maxResults = 8
              ;

              if(index >= maxResults) {
                return false;
              }

              // create new language category
              if(response.results[parent_label] === undefined) {
                response.results[parent_label] = {
                  name    : parent_label,
                  results : []
                };
              }
              // add result to category
              response.results[parent_label].results.push({
                title       : item.label,
                description : item.description
              });
            });
            return response;
          },
          url: '{{ .apiBaseUrl}}/v1/label/search?q={query}'
        }//,
        //fields: {
        //  results : 'items',
        //  title   : 'label'
        //},
        minCharacters : 2,
        searchOnFocus: false,
        showNoResults: false,
      });*/

  $('.ui.dropdown')
  .dropdown()
  ;

  new Fingerprint2().get(function(result, components){
    browserFingerprint = result;
  });

});
</script>
</head>
<body>

  {{ template "menu.html" .}}

  <!-- Page Contents -->
  <div class="pusher">
    <div class="ui inverted vertical masthead center aligned segment">
      {{ template "pointing_menu.html" .}}
      <div class="ui text container">
       <h2 class="ui inverted header">Label all objects</h2>
     </div>
   </div>

   <div class="ui stackable grid vertical stripe mobile reversed">
    <div class="one wide column">
    </div>

    <div class="four wide center aligned mobile only column">
      {{ template "img_info.html" .}}
    </div>

    <div class="three wide center aligned column">
      <p><h2>Labels:</h2></p>
      <p hidden id="noLabelsDefined">There are currently no labels defined for that image. Add labels and help to improve our dataset.</p>

      <div class="ui labels" id="labels">
      </div>

      <h1></h1>
      <h1></h1>
      <div id="mostPopularLabelsContainer" hidden>
        <h2 style="margin-bottom:0px;">Most Popular Labels:</h2>
        <p style="font-size:12px; margin-bottom:20px;">These are the most popular labels in the whole dataset</p>
        <div class="ui labels" id="mostPopularLabels">
        </div>
      </div>

    </div>
    <div class="eight wide center aligned column">
      <img class="ui large image centered" src="donations/{{ .image.Id }}" imageId="{{ .image.Id }}" id="image">
      

      <h2></h2>
      <p>Do you see any objects without a label? Add them here</p>
      <div class="ui centered grid">
        <div class="row">
          <div class="ui search">
            <div class="ui center aligned action input">
              <!--<input class="prompt" placeholder="Enter Label..." type="text" id="newLabel">-->
              <div class="ui search selection dropdown" id="labelDropdown">
                <div class="default text">Select Label</div>
                <div class="menu">
                  {{ range $key, $value := .labels }}
                  <div class="item" data-value="{{ $key }}"><i class="tag icon"></i>{{ $key }}</div>
                  {{ end }}
                </div>
              </div>


              <button class="ui button" id="addLabelButton">Add</button>
            </div>
          </div>
          <h1></h1>
        </div>
      </div>

      <div class="row">
        <div class="ui centered grid">
          <div class="four wide center aligned column">
            <button class="ui fluid positive button" id="doneButton">Done</button>
          </div>
        </div>
      </div>

      <div class="ui warning message" hidden id="labelAlreadyExistsMessage">
        <i class="close icon"></i>
        <div class="header">
          Label already exists
        </div>
      </div>

      {{ template "label_help_dlg.html" .}}
      {{ template "report_dlg.html" .}}
    </div>


    <div class="four wide center aligned computer only column">
      {{ template "img_info.html" .}}
    </div>
  </div>


</div>
{{ template "footer.html" .}}

</body>

</html>